<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GourmetClient.Maui.ViewModels"
             x:Class="GourmetClient.Maui.Pages.BillingPage"
             x:DataType="vm:BillingViewModel"
             Title="Billing"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}">

    <Grid RowDefinitions="Auto,*">
        <!-- Month Picker -->
        <Border Grid.Row="0"
                Margin="16,12"
                Padding="12"
                StrokeShape="RoundRectangle 12"
                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">
            <Picker ItemsSource="{Binding AvailableMonths}"
                    SelectedItem="{Binding SelectedMonth}"
                    Title="Select Month"
                    TitleColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                    TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"
                    HorizontalOptions="Fill" />
        </Border>

        <!-- Billing Content -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">
            <ScrollView>
                <VerticalStackLayout Padding="16" Spacing="16">
                    <!-- Food Section -->
                    <Border StrokeShape="RoundRectangle 12"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                            IsVisible="{Binding HasFoodItems}">
                        <VerticalStackLayout>
                            <!-- Header -->
                            <Grid ColumnDefinitions="*,Auto"
                                  Padding="16"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Gray50}, Dark={StaticResource Gray700}}">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleFoodExpandedCommand}" />
                                </Grid.GestureRecognizers>
                                <Label Text="Food"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                <Label Grid.Column="1"
                                       Text="{Binding FoodTotal, StringFormat='{0:C}'}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}" />
                            </Grid>

                            <!-- Items -->
                            <CollectionView ItemsSource="{Binding FoodItems}"
                                            IsVisible="{Binding IsFoodExpanded}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:BillingItemViewModel">
                                        <Grid ColumnDefinitions="Auto,*,Auto"
                                              Padding="16,8">
                                            <Label Text="{Binding CountText}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                   WidthRequest="40" />
                                            <Label Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"
                                                   LineBreakMode="TailTruncation" />
                                            <Label Grid.Column="2"
                                                   Text="{Binding TotalText}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Drinks Section -->
                    <Border StrokeShape="RoundRectangle 12"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                            IsVisible="{Binding HasDrinkItems}">
                        <VerticalStackLayout>
                            <Grid ColumnDefinitions="*,Auto"
                                  Padding="16"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Gray50}, Dark={StaticResource Gray700}}">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleDrinksExpandedCommand}" />
                                </Grid.GestureRecognizers>
                                <Label Text="Drinks"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                <Label Grid.Column="1"
                                       Text="{Binding DrinksTotal, StringFormat='{0:C}'}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}" />
                            </Grid>

                            <CollectionView ItemsSource="{Binding DrinkItems}"
                                            IsVisible="{Binding IsDrinksExpanded}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:BillingItemViewModel">
                                        <Grid ColumnDefinitions="Auto,*,Auto"
                                              Padding="16,8">
                                            <Label Text="{Binding CountText}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                   WidthRequest="40" />
                                            <Label Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"
                                                   LineBreakMode="TailTruncation" />
                                            <Label Grid.Column="2"
                                                   Text="{Binding TotalText}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Other Section -->
                    <Border StrokeShape="RoundRectangle 12"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                            IsVisible="{Binding HasOtherItems}">
                        <VerticalStackLayout>
                            <Grid ColumnDefinitions="*,Auto"
                                  Padding="16"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Gray50}, Dark={StaticResource Gray700}}">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleOtherExpandedCommand}" />
                                </Grid.GestureRecognizers>
                                <Label Text="Other"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                <Label Grid.Column="1"
                                       Text="{Binding OtherTotal, StringFormat='{0:C}'}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}" />
                            </Grid>

                            <CollectionView ItemsSource="{Binding OtherItems}"
                                            IsVisible="{Binding IsOtherExpanded}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:BillingItemViewModel">
                                        <Grid ColumnDefinitions="Auto,*,Auto"
                                              Padding="16,8">
                                            <Label Text="{Binding CountText}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                   WidthRequest="40" />
                                            <Label Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"
                                                   LineBreakMode="TailTruncation" />
                                            <Label Grid.Column="2"
                                                   Text="{Binding TotalText}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Grand Total -->
                    <Border StrokeShape="RoundRectangle 12"
                            BackgroundColor="{StaticResource Primary}"
                            Padding="16"
                            IsVisible="{Binding HasAnyItems}">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Total"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="White" />
                            <Label Grid.Column="1"
                                   Text="{Binding GrandTotal, StringFormat='{0:C}'}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="White" />
                        </Grid>
                    </Border>

                    <!-- Empty State -->
                    <VerticalStackLayout IsVisible="{Binding HasNoItems}"
                                         HorizontalOptions="Center"
                                         Padding="32">
                        <Label Text="No transactions for this month"
                               FontSize="16"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

        <!-- Loading Overlay -->
        <ActivityIndicator Grid.Row="1"
                           IsVisible="{Binding IsLoading}"
                           IsRunning="{Binding IsLoading}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Color="{StaticResource Primary}" />
    </Grid>
</ContentPage>
