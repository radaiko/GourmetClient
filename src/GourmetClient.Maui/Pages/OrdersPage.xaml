<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GourmetClient.Maui.ViewModels"
             x:Class="GourmetClient.Maui.Pages.OrdersPage"
             x:DataType="vm:OrdersViewModel"
             Title="Orders"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}">

    <Grid RowDefinitions="Auto,*">
        <!-- Filter Tabs -->
        <Grid Grid.Row="0"
              ColumnDefinitions="*,*"
              Padding="16,12"
              BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">

            <Button Grid.Column="0"
                    Text="Upcoming"
                    Command="{Binding ShowUpcomingCommand}"
                    BackgroundColor="{Binding IsShowingUpcoming, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Primary|Transparent}"
                    TextColor="{Binding IsShowingUpcoming, Converter={StaticResource BoolToColorConverter}, ConverterParameter=White|Gray600}"
                    CornerRadius="20"
                    HeightRequest="40" />

            <Button Grid.Column="1"
                    Text="Past"
                    Command="{Binding ShowPastCommand}"
                    BackgroundColor="{Binding IsShowingPast, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Primary|Transparent}"
                    TextColor="{Binding IsShowingPast, Converter={StaticResource BoolToColorConverter}, ConverterParameter=White|Gray600}"
                    CornerRadius="20"
                    HeightRequest="40" />
        </Grid>

        <!-- Orders List -->
        <Grid Grid.Row="1">
            <CollectionView ItemsSource="{Binding GroupedOrders}"
                            IsGrouped="True"
                            IsVisible="{Binding HasOrders}">
                <CollectionView.GroupHeaderTemplate>
                    <DataTemplate x:DataType="vm:OrderGroupViewModel">
                        <Label Text="{Binding DateHeader}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                               Padding="16,16,16,8"
                               BackgroundColor="{AppThemeBinding Light={StaticResource Gray50}, Dark={StaticResource Gray900}}" />
                    </DataTemplate>
                </CollectionView.GroupHeaderTemplate>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:OrderItemViewModel">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Execute">
                                    <SwipeItem Text="Cancel"
                                               BackgroundColor="{StaticResource Danger}"
                                               Command="{Binding CancelOrderCommand}"
                                               IsVisible="{Binding CanCancel}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <Border Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                    StrokeThickness="1"
                                    StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                                    Padding="16"
                                    Margin="16,4">
                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                    <!-- Title -->
                                    <Label Grid.Row="0" Grid.Column="0"
                                           Text="{Binding Title}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />

                                    <!-- Status Badge -->
                                    <Border Grid.Row="0" Grid.Column="1"
                                            BackgroundColor="{Binding StatusColor}"
                                            StrokeShape="RoundRectangle 10"
                                            Padding="8,4">
                                        <Label Text="{Binding StatusText}"
                                               FontSize="12"
                                               TextColor="White" />
                                    </Border>

                                    <!-- Category -->
                                    <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                           Text="{Binding CategoryName}"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                           Margin="0,4,0,0" />
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Empty State -->
            <VerticalStackLayout IsVisible="{Binding HasNoOrders}"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"
                                 Padding="32">
                <Label Text="{Binding EmptyStateText}"
                       FontSize="18"
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
            </VerticalStackLayout>

            <!-- Loading Indicator -->
            <ActivityIndicator IsVisible="{Binding IsLoading}"
                               IsRunning="{Binding IsLoading}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Color="{StaticResource Primary}" />

            <!-- FAB for pending cancellations -->
            <Button Text="{Binding PendingCancelsText}"
                    Command="{Binding ExecuteCancelsCommand}"
                    IsVisible="{Binding HasPendingCancels}"
                    HorizontalOptions="End"
                    VerticalOptions="End"
                    Margin="16"
                    Padding="20,12"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontAttributes="Bold"
                    CornerRadius="28"
                    Shadow="{Shadow Brush=Black, Offset='2,4', Radius=8, Opacity=0.3}" />
        </Grid>
    </Grid>
</ContentPage>
