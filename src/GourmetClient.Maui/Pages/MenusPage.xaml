<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GourmetClient.Maui.ViewModels"
             x:Class="GourmetClient.Maui.Pages.MenusPage"
             x:DataType="vm:MenusViewModel"
             Title="Menus"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}">

    <Grid RowDefinitions="Auto,*">
        <!-- Date Navigation Bar -->
        <Grid Grid.Row="0"
              ColumnDefinitions="Auto,*,Auto"
              Padding="16,12"
              BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">

            <Button Grid.Column="0"
                    Text="◀"
                    Command="{Binding PreviousDayCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                    FontSize="20"
                    WidthRequest="44"
                    HeightRequest="44" />

            <VerticalStackLayout Grid.Column="1"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center">
                <Label Text="{Binding CurrentDayName}"
                       FontSize="18"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                <Label Text="{Binding CurrentDateFormatted}"
                       FontSize="14"
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
            </VerticalStackLayout>

            <Button Grid.Column="2"
                    Text="▶"
                    Command="{Binding NextDayCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                    FontSize="20"
                    WidthRequest="44"
                    HeightRequest="44" />
        </Grid>

        <!-- Main Content Area -->
        <Grid Grid.Row="1">
            <!-- CarouselView for day-by-day swiping -->
            <CarouselView ItemsSource="{Binding MenuDays}"
                          CurrentItem="{Binding CurrentMenuDay}"
                          Loop="False"
                          IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">
                <CarouselView.ItemTemplate>
                    <DataTemplate x:DataType="vm:MenuDayViewModel">
                        <ScrollView>
                            <VerticalStackLayout Padding="16" Spacing="16">
                                <!-- Empty state for day -->
                                <Label Text="No menus available for this day"
                                       IsVisible="{Binding HasNoMenus}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                       FontSize="16"
                                       Margin="0,40,0,0" />

                                <!-- Menu Categories -->
                                <CollectionView ItemsSource="{Binding Categories}"
                                                IsVisible="{Binding HasMenus}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="vm:MenuCategoryViewModel">
                                            <VerticalStackLayout Spacing="8" Margin="0,0,0,16">
                                                <!-- Category Header -->
                                                <Label Text="{Binding CategoryName}"
                                                       FontSize="14"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                                       Margin="0,0,0,4" />

                                                <!-- Menu Items in Category -->
                                                <CollectionView ItemsSource="{Binding Menus}">
                                                    <CollectionView.ItemTemplate>
                                                        <DataTemplate x:DataType="vm:MenuItemViewModel">
                                                            <Border Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                                                    StrokeThickness="1"
                                                                    StrokeShape="RoundRectangle 12"
                                                                    BackgroundColor="{Binding BackgroundColor}"
                                                                    Padding="16"
                                                                    Margin="0,4">
                                                                <Border.GestureRecognizers>
                                                                    <TapGestureRecognizer Command="{Binding ToggleOrderCommand}" />
                                                                </Border.GestureRecognizers>

                                                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto">
                                                                    <!-- Title -->
                                                                    <Label Grid.Row="0" Grid.Column="0"
                                                                           Text="{Binding Title}"
                                                                           FontSize="16"
                                                                           FontAttributes="Bold"
                                                                           TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"
                                                                           LineBreakMode="TailTruncation" />

                                                                    <!-- State Indicator -->
                                                                    <Label Grid.Row="0" Grid.Column="1"
                                                                           Text="{Binding StateIcon}"
                                                                           FontSize="20"
                                                                           VerticalOptions="Center" />

                                                                    <!-- Subtitle -->
                                                                    <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                                           Text="{Binding Subtitle}"
                                                                           FontSize="14"
                                                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                                                           LineBreakMode="WordWrap"
                                                                           IsVisible="{Binding HasSubtitle}" />

                                                                    <!-- Allergens -->
                                                                    <Label Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                                                           Text="{Binding AllergensText}"
                                                                           FontSize="12"
                                                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                                                                           IsVisible="{Binding HasAllergens}"
                                                                           Margin="0,4,0,0" />
                                                                </Grid>
                                                            </Border>
                                                        </DataTemplate>
                                                    </CollectionView.ItemTemplate>
                                                </CollectionView>
                                            </VerticalStackLayout>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>
                        </ScrollView>
                    </DataTemplate>
                </CarouselView.ItemTemplate>
            </CarouselView>

            <!-- Loading Indicator -->
            <VerticalStackLayout IsVisible="{Binding IsLoading}"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   Color="{StaticResource Primary}"
                                   HeightRequest="50"
                                   WidthRequest="50" />
                <Label Text="Loading menus..."
                       HorizontalOptions="Center"
                       Margin="0,16,0,0"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
            </VerticalStackLayout>

            <!-- Login Required State -->
            <VerticalStackLayout IsVisible="{Binding NeedsLogin}"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"
                                 Padding="32">
                <Label Text="Please log in to view menus"
                       FontSize="18"
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                <Button Text="Go to Settings"
                        Command="{Binding GoToSettingsCommand}"
                        Margin="0,16,0,0"
                        BackgroundColor="{StaticResource Primary}" />
            </VerticalStackLayout>

            <!-- FAB for pending orders -->
            <Button Text="{Binding PendingChangesText}"
                    Command="{Binding ExecuteOrderCommand}"
                    IsVisible="{Binding HasPendingChanges}"
                    HorizontalOptions="End"
                    VerticalOptions="End"
                    Margin="16,16,16,16"
                    Padding="20,12"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontAttributes="Bold"
                    CornerRadius="28"
                    Shadow="{Shadow Brush=Black, Offset='2,4', Radius=8, Opacity=0.3}" />
        </Grid>
    </Grid>
</ContentPage>
